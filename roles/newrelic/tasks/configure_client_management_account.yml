- name: Set Variables
  set_fact: 
    # change this to be bss dev user id (currently is Omars user id)
    service_account_user_id: 1006596928

- name: Get New Relic Service Account Key
  delegate_to: localhost
  shell: |
    API_KEY=$(aws ssm get-parameter --name /secrets/new_relic/api_key --with-decryption --query "Parameter.Value" --output text)
    echo $API_KEY
  register: get_api_key_output

- name: Query New Relic Groups
  delegate_to: localhost
  shell: |
    QUERY_GROUP_RESPONSE=$(curl https://api.newrelic.com/graphql \
      -H 'Content-Type: application/json' \
      -H 'API-Key: {{ get_api_key_output.stdout }}' \
      --data-binary '{
                      "query": "{actor {organization {userManagement {authenticationDomains(id: \"{{ authentication_domain_id }}\") {authenticationDomains {groups {groups {displayName id users {users {name id}}}}}}}}}}",
                      "variables": ""
                    }'
    )
    echo $QUERY_GROUP_RESPONSE
  register: query_new_relic_groups

- name: Set Query Group as Fact
  set_fact:
    query_group: "{{ query_new_relic_groups.stdout | from_json }}"

- name: Create client_management_group_name Group if does not exist
  delegate_to: localhost
  shell: |
    CLIENT_MANAGEMENT_GROUP=$(echo '{{ query_group | to_json }}' | jq '.data.actor.organization.userManagement.authenticationDomains.authenticationDomains.[0].groups.groups.[] | select(.displayName == "{{ client_management_group_name }}")')

    if [ -z "$CLIENT_MANAGEMENT_GROUP" ]; then
      # create group if does not exist
      CREATE_GROUP_RESPONSE=$(curl https://api.newrelic.com/graphql \
        -H 'Content-Type: application/json' \
        -H 'API-Key: {{ get_api_key_output.stdout }}' \
        --data-binary '{
                        "query": "mutation {userManagementCreateGroup(createGroupOptions: {authenticationDomainId: \"{{ authentication_domain_id }}\" displayName: \"{{ client_management_group_name }}\" }) {group {displayName id}}}",
                        "variables": ""
                      }'
      )
      GROUP_ID=$(echo $CREATE_GROUP_RESPONSE | jq -r .data.userManagementCreateGroup.group.id)
      echo $GROUP_ID
    else
      GROUP_ID=$(echo $CLIENT_MANAGEMENT_GROUP | jq -r .id)
      echo $GROUP_ID
    fi

  register: client_management_group_id

- name: Set Client Management Group Id as Fact
  set_fact:
    group_id: "{{ client_management_group_id.stdout }}"

- name: Add Service Account User to group 
  delegate_to: localhost
  shell: |
    CLIENT_MANAGEMENT_GROUP=$(echo '{{ query_group | to_json }}' | jq '.data.actor.organization.userManagement.authenticationDomains.authenticationDomains.[0].groups.groups.[] | select(.displayName == "{{ client_management_group_name }}")')

    SERVICE_ACCOUNT_USER=$(echo $CLIENT_MANAGEMENT_GROUP | jq '.users.users.[] | select(.id == "{{ service_account_user_id }}")' )

    if [ -z "$SERVICE_ACCOUNT_USER" ]; then
      # Add service user to group
      ADD_USER_RESPONSE=$(curl https://api.newrelic.com/graphql \
        -H 'Content-Type: application/json' \
        -H 'API-Key: {{ get_api_key_output.stdout }}' \
        --data-binary '{
                        "query": "mutation {userManagementAddUsersToGroups(addUsersToGroupsOptions: {groupIds: [\"{{group_id}}\"] userIds: [\"{{service_account_user_id}}\"]}) {groups {displayName id}}}",
                        "variables": ""
                      }'
      )

    fi
